<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Crecimiento Pedi치trico OMS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #333;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--box-shadow);
            border: 1px solid #e9ecef;
        }
        h1, h2 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--secondary-color);
        }
        input[type="date"], input[type="number"], select {
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            padding: 14px 20px;
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 123, 255, 0.3);
        }
        #chartContainer {
            min-height: 450px;
        }
        #results {
            margin-top: 20px;
            padding: 20px;
            background-color: #e9f5ff;
            border-left: 5px solid var(--primary-color);
            border-radius: 8px;
            display: none;
        }
        #results p {
            margin: 0;
            font-size: 1.1em;
            font-weight: 500;
        }
        #results span {
            font-weight: bold;
            color: var(--primary-color);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1>游늵 Calculadora de Crecimiento Pedi치trico (OMS)</h1>
        <div class="form-grid">
            <div class="form-group">
                <label for="dob">Fecha de Nacimiento</label>
                <input type="date" id="dob" required>
            </div>
            <div class="form-group">
                <label for="sex">Sexo</label>
                <select id="sex">
                    <option value="boys">Ni침o</option>
                    <option value="girls">Ni침a</option>
                </select>
            </div>
            <div class="form-group">
                <label for="weight">Peso (kg)</label>
                <input type="number" id="weight" step="0.1" placeholder="Ej: 5.5" required>
            </div>
            <div class="form-group">
                <button onclick="calculateGrowth()">Calcular y Graficar</button>
            </div>
        </div>
    </div>

    <div class="card" id="resultsCard" style="display: none;">
        <h2>Resultados</h2>
        <div id="chartContainer">
            <canvas id="growthChart"></canvas>
        </div>
        <div id="results">
            <p id="resultText"></p>
        </div>
    </div>
</div>

<script>
    // Datos OMS Peso-Edad (0-60 meses)
    // Fuente: WHO Child Growth Standards - Expanded tables for constructing national health cards
    // wfa_boys_0_5_zscores.txt & wfa_girls_0_5_zscores.txt
    // Columnas: Age (days), L, M, S
    // NOTA: Por brevedad, se incluyen datos cada ~30 d칤as. Para m치xima precisi칩n, usar la tabla completa.
    const whoData = {
        boys: [
            [0,1.5799,3.3468,0.14539],[30,-0.2709,4.3857,0.13788],[61,-0.7853,5.6041,0.13063],[91,-1.0253,6.4258,0.12595],[122,-1.1594,7.0374,0.12267],[152,-1.258,7.5355,0.12023],[183,-1.3343,7.9546,0.11832],[213,-1.3966,8.3129,0.11677],[244,-1.4484,8.6231,0.11545],[274,-1.4925,8.895,0.11432],[305,-1.5303,9.1368,0.11333],[335,-1.563,9.3541,0.11246],[365,-1.5913,9.5516,0.11168],[396,-1.6166,9.7348,0.11099],[426,-1.639,9.904,0.11037],[457,-1.659,10.062,0.10982],[487,-1.6769,10.21,0.10931],[518,-1.693,10.35,0.10885],[549,-1.7075,10.48,0.10842],[579,-1.7206,10.61,0.10802],[609,-1.7323,10.73,0.10766],[730,-1.7766,11.23,0.10652],[913,-1.8213,11.96,0.10613],[1095,-1.8157,12.71,0.10738],[1278,-1.7709,13.48,0.10935],[1461,-1.6917,14.28,0.11191],[1643,-1.587,15.11,0.11494],[1826,-1.464,15.97,0.11832]
        ],
        girls: [
            [0,1.3872,3.2343,0.14488],[30,-0.2224,4.038,0.13845],[61,-0.6657,4.9789,0.13175],[91,-0.8923,5.6542,0.1273],[122,-1.0253,6.1738,0.12423],[152,-1.1193,6.5985,0.12198],[183,-1.1917,6.9583,0.12022],[213,-1.2504,7.2713,0.11879],[244,-1.2995,7.5482,0.11758],[274,-1.3414,7.7972,0.11654],[305,-1.3775,8.024,0.11562],[335,-1.4089,8.2323,0.11481],[365,-1.4363,8.425,0.11409],[396,-1.4606,8.6056,0.11345],[426,-1.482,8.775,0.11287],[457,-1.5011,8.935,0.11235],[487,-1.518,9.086,0.11187],[518,-1.5331,9.23,0.11144],[549,-1.5466,9.367,0.11105],[579,-1.5587,9.497,0.11069],[609,-1.5695,9.622,0.11037],[730,-1.6111,10.15,0.10935],[913,-1.656,10.9,0.10953],[1095,-1.6506,11.66,0.11116],[1278,-1.5972,12.45,0.11363],[1461,-1.506,13.27,0.11671],[1643,-1.3879,14.12,0.12022],[1826,-1.2526,15,0.12401]
        ]
    };

    let growthChart = null;

    function calculateGrowth() {
        const dob = document.getElementById('dob').value;
        const weight = parseFloat(document.getElementById('weight').value);
        const sex = document.getElementById('sex').value;

        if (!dob || isNaN(weight)) {
            alert('Por favor, complete todos los campos.');
            return;
        }

        const dobDate = new Date(dob);
        const today = new Date();
        const ageInDays = Math.floor((today - dobDate) / (1000 * 60 * 60 * 24));
        const ageInMonths = ageInDays / 30.4375;

        if (ageInDays < 0 || ageInDays > 1856) {
             alert('La fecha de nacimiento es inv치lida o el paciente es mayor de 60 meses (5 a침os). Esta tabla solo cubre hasta los 5 a침os.');
            return;
        }

        const data = whoData[sex];
        const [day, L, M, S] = getLMS(ageInDays, data);

        const zScore = (((weight / M) ** L) - 1) / (L * S);

        document.getElementById('resultsCard').style.display = 'block';
        document.getElementById('results').style.display = 'block';
        document.getElementById('resultText').innerHTML = `
            Paciente de <strong>${Math.floor(ageInMonths)} meses (${ageInDays} d칤as)</strong>
            <br>Peso: <strong>${weight.toFixed(1)} kg</strong>
            <br>Z-Score (DE): <span>${zScore.toFixed(2)}</span>
        `;
        
        plotChart(ageInDays, weight, sex, M, L, S);
    }
    
    function getLMS(ageInDays, data) {
        // En una implementaci칩n real, se deber칤a interpolar.
        // Por simplicidad, encontramos el m치s cercano.
        let closest = data.reduce((prev, curr) => 
            (Math.abs(curr[0] - ageInDays) < Math.abs(prev[0] - ageInDays) ? curr : prev)
        );
        return closest;
    }

    function calculateWeightFromZ(Z, L, M, S) {
        return M * (1 + L * S * Z)**(1/L);
    }

    function plotChart(ageInDays, patientWeight, sex, M, L, S) {
        const ctx = document.getElementById('growthChart').getContext('2d');
        const labels = [];
        const datasets = [
            { label: '+3 SD', borderColor: '#d9534f', data: [], fill: false, borderWidth: 2, pointRadius: 0 },
            { label: '+2 SD', borderColor: '#f0ad4e', data: [], fill: false, borderWidth: 2, pointRadius: 0 },
            { label: '+1 SD', borderColor: '#5bc0de', data: [], fill: false, borderWidth: 1.5, pointStyle: 'dash' },
            { label: 'Median (0 SD)', borderColor: '#5cb85c', data: [], fill: false, borderWidth: 3, pointRadius: 0 },
            { label: '-1 SD', borderColor: '#5bc0de', data: [], fill: false, borderWidth: 1.5, pointStyle: 'dash' },
            { label: '-2 SD', borderColor: '#f0ad4e', data: [], fill: false, borderWidth: 2, pointRadius: 0 },
            { label: '-3 SD', borderColor: '#d9534f', data: [], fill: false, borderWidth: 2, pointRadius: 0 }
        ];

        const dataPoints = whoData[sex];
        dataPoints.forEach(point => {
            const currentAgeDays = point[0];
            const currentL = point[1];
            const currentM = point[2];
            const currentS = point[3];
            const ageInMonths = (currentAgeDays / 30.4375).toFixed(1);
            
            labels.push(currentAgeDays);
            datasets[0].data.push({x: currentAgeDays, y: calculateWeightFromZ(3, currentL, currentM, currentS).toFixed(2)});
            datasets[1].data.push({x: currentAgeDays, y: calculateWeightFromZ(2, currentL, currentM, currentS).toFixed(2)});
            datasets[2].data.push({x: currentAgeDays, y: calculateWeightFromZ(1, currentL, currentM, currentS).toFixed(2)});
            datasets[3].data.push({x: currentAgeDays, y: calculateWeightFromZ(0, currentL, currentM, currentS).toFixed(2)});
            datasets[4].data.push({x: currentAgeDays, y: calculateWeightFromZ(-1, currentL, currentM, currentS).toFixed(2)});
            datasets[5].data.push({x: currentAgeDays, y: calculateWeightFromZ(-2, currentL, currentM, currentS).toFixed(2)});
            datasets[6].data.push({x: currentAgeDays, y: calculateWeightFromZ(-3, currentL, currentM, currentS).toFixed(2)});
        });

        // A침adir el punto del paciente
        const patientData = {
            label: 'Paciente',
            data: [{ x: ageInDays, y: patientWeight }],
            backgroundColor: 'blue',
            borderColor: 'white',
            pointRadius: 8,
            pointHoverRadius: 10,
            type: 'scatter'
        };
        
        if (growthChart) {
            growthChart.destroy();
        }

        growthChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [...datasets, patientData]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Curva de Crecimiento OMS: Peso para la Edad (${sex === 'boys' ? 'Ni침os' : 'Ni침as'})`,
                        font: { size: 18 }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        type: 'linear', // Usar escala lineal para d칤as
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'Edad (d칤as)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Peso (kg)'
                        }
                    }
                }
            }
        });
    }

</script>
</body>
</html>
